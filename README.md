# Bitrix24 REST API Get Users
Script for retrieving users from Bitrix24.

## Development instructions / how to run the script
### On Windows 10
1. Install WSL (Windows Subsystem Linux (the easiest way to use Linux in Windows)

### Installing Python3 and virtualenv on Debian WSL
1. Clone the repository

       git clone https://github.com/iisti/bitrix24_rest_api_get_users.git
1. Install Python3 and pip3

       sudo apt-get install python3 python3-pip
1. Install virtualenv using pip3

       pip3 install virtualenv
1. Create virtual environment

       virtualenv bitrix24_rest_api_get_users/virtualenv
       # If you get error "virtualenv: command not found", relogin into shell and try again.
1. Activate virtual environment

       source bitrix24_rest_api_get_users/virtualenv/bin/activate
1. One can check which virtualenv is in use by:

       echo $VIRTUAL_ENV
       /home/iisti/scripts/bitrix24_rest_api_get_users/virtualenv
1. Deactivate (just to know how it's done)

       deactivate

1. Install modules

        # Remember to activate virtualenv before
        pip3 install -r requirements.txt



## Create an Application/Webhook (this is necessary)
1. Login with browser to your Bitrix24 online site or use the Bitrix24 application.
1. From left menut select **Developer resources**
1. Select **Import and export data** -> **Other**
    * Example for retrieving users
      ~~~
      Name: Set the name in the header, the default name is "Other"
      Webhook to call REST API: <this is autogenerated>
      Request Builder
        Method: user.get
        Parameters: ADMIN_MODE true
        URL: https://mycompany.bitrix24.de/rest/36/wwwwsdzzxxxx/user.get.json?ADMIN_MODE=true
      Widgets: Unchecked
      Assign permissions:
        Users
      ~~~
         * ADMIN_MODE true is required for retrieving all internal/external users.
         * There's error **insufficient_scope** if one does not save the "Application"
         ~~~
         Array
         (
             [error] => insufficient_scope
             [error_description] => The request requires higher privileges than provided by the webhook token
         )
         ~~~
    * Click Save and Execute to see if the "Application" works.
1. Create another Application/Webhook for retrieving departments.
    * Example for retrieving users
      ~~~
      Name: Set the name in the header, the default name is "Other"
      Webhook to call REST API: <this is autogenerated>
      Request Builder
        Method: department.get
        Parameters: none
        URL: https://mycompany.bitrix24.de/rest/36/wwwwsdzzxxxx/department.get.json
      Widgets: Unchecked
      Assign permissions:
        Company structure (department)
      ~~~
         * There's error **insufficient_scope** if one does not save the "Application"
         ~~~
         Array
         (
             [error] => insufficient_scope
             [error_description] => The request requires higher privileges than provided by the webhook token
         )
         ~~~
    * Click Save and Execute to see if the "Application" works.

## Configure config.ini and run the script
1. Put the webhook URLs generated in the previous section into config.ini
    ~~~
    cp config_example.ini config.ini
    # Edit config.ini
    ~~~
1. Run the script to retrieve users
    ~~~
    python3 ./get_users.py -c config.ini
    2021-04-08 07:32:25,289 - INFO - Loaded configuration:
    base_dir = .
    output_path = ./output/
    log_path = ./logs/
    log_level = info
    users_webhook_url = https://mycompany.bitrix24.de/rest/36/xxxxxxxxxxx/user.get.json?ADMIN_MODE=true
    department_webhook_url = https://mycompany.bitrix24.de/rest/36/7xxxxxxx/department.get.json
    2021-04-08 07:32:25,294 - INFO - Combining users with departments
    2021-04-08 07:32:25,294 - INFO - Retriving users from Bitrix24
    2021-04-08 07:32:25,544 - INFO - Writing JSON: ./output/bitrix24_all_user_data_20210408-073225.json
    2021-04-08 07:32:25,556 - INFO - Retriving department from Bitrix24
    2021-04-08 07:32:25,698 - INFO - Writing JSON: ./output/bitrix24_department_data_20210408-073225.json
    2021-04-08 07:32:25,703 - INFO - Writing JSON: ./output/bitrix24_org_20210408-073225.json
    2021-04-08 07:32:25,709 - INFO - Writing CSV of organisation: ./output/org_20210408-073225.csv
    ~~~
